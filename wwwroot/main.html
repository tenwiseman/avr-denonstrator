<!DOCTYPE html>
<html >
    <head>
        <title>Denonstrator</title>

        <style type="text/css">

            h1 {
                font-size: medium;
                margin: 0;
            }

            form {
                padding: 10px;
            }

            #command {
                border-style: inset;
            }

            .container {
                display: flex; 
                flex-wrap: wrap;
                width: 750px;
                padding: 0 10px;
                border-left: 1px solid black;
                border-right: 1px solid black;
                background-color: lightgray;
                font-family: Arial, Helvetica, sans-serif;
            }

            #row1 {
                padding: 10px;
                border-top: 1px solid black;
                border-top-left-radius: 10px;
                border-top-right-radius: 10px;
            }

            #row3 {
                padding: 10px;
                border-bottom: 1px solid black;
                border-bottom-left-radius: 10px;
                border-bottom-right-radius: 10px;
            }

            .column1, .column2 {
                flex: 1;
            }




            .column1 {
                background-color: lightslategray;
            }


            .column2 {
                background-color: lightslategray;
            }

            #online {
                width:30px;
                height:20px;
                background-color: green;
            }

            /* BUTTONS */

            .buttons {
                display: flex; 
                flex-wrap: wrap;
                margin: 10px;
              
                
            }

            .buttons button, .buttons div {
                flex: 1 0 21%;
                width:50px;
                height:20px;
                margin: 4px;
            }


            /* OSD */

            #osd {
               
                height: 250px;
                margin: 10px;
                border: 1px solid black;
                overflow: scroll;
                border-style: inset;
                background-color: darkslategray;
                color: cyan;
            }

            #osd span {
                margin: 0 10px;
                padding: 2px;
                display: block;
            }

            #osd span:first-child {
                margin: 10px;
                font-weight: bold;
                text-decoration: underline;
            }

            /* RESULTS */


            #results {
               
                height: 400px;
                margin-left: 10px;
                border: 1px solid black;
                overflow: scroll;
                border-style: inset;
                background-color: linen;
            }
            
            #results span, #sosd span {
                padding: 2px;
                border: 1px solid lightgray;
                display: inline-block;
            }

            #results div:first-child {
                background-color: lightgray;
            }

            #results span:first-child {
                width: 100px;
                color: lightslategray;
            }

            #results span:nth-child(2) {
                width: 50px;
                color: black;
            }

            #results span:nth-child(3) {
                width: 180px;
            }

        </style>

        <script type="text/javascript">

            const aborter = new AbortController();
            const decoder = new TextDecoder();

            /* connect streaming data input from server */

            async function clientConnect(signal) {
     
                // execute this function after window DOM loaded!

                const response = await fetch('http://localhost:8000/connect', { 
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: signal,
                    method: 'GET',
                });


                const online = document.getElementById('online');
                const results = document.getElementById('results');


                for await (const chunk of response.body) {
                    if (signal.aborted) throw signal.reason;
                    const whole = decoder.decode(chunk, { stream: true });

                    // CSV data is received in variable chunks of field pairs
                    // remove last comma, and split to fields 
                    const fields = whole.slice(0, -1).split(',');

                    for (let i = 0; i < fields.length; i += 3) {
                        switch (fields[i+1]) {
                            case 'error':
                                online.style.backgroundColor = 'red';
                                break;
                            case 'OK':
                                online.style.backgroundColor = 'green';
                                break;
                        }

                        if (fields[i+1] !== 'OK') { 

                            // first field - Timestamp  
                            const col1 = document.createElement('span');
                            const txt1 = document.createTextNode(fields[i]);
                            col1.appendChild(txt1);

                            // second field - Command / Event   
                            const col2 = document.createElement('span');
                            const txt2 = document.createTextNode(fields[i+1]);
                            col2.appendChild(txt2);

                            // third field - Result
                            var result = fields[i+2];
                            const col3 = document.createElement('span');
                            
                            if (result.includes('NS')) {
                                osd = 'field' + result.substr(3, 1);
                                document.getElementById(osd).innerHTML = result.slice(4);
                            }
                            const txt3 = document.createTextNode(result);
                            col3.appendChild(txt3);

                            // create row, add field elements
                            const row = document.createElement('div');
                            row.appendChild(col1);
                            row.appendChild(col2);
                            row.appendChild(col3);
                            results.appendChild(row);

                            row.scrollIntoView({block: "end", inline: "nearest"});
                        }
                    }
                }

            }

            // on form submit
            async function formSubmit(e) {
                e.preventDefault();
               
                const o = {};
                new FormData(form).forEach( ( value, key) => o[key] = value);

                const response = await fetch('http://localhost:8000/query', { 
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    method: 'POST',
                    body: JSON.stringify( o )
                });

                if(!response.ok) {
                    const msg = await response.text();
                    if (msg === 'Message is required') {
                        alert(msg);
                    } else if (msg === 'Reconnect Stream') {
                        clientConnect(aborter.signal);
                        formSubmit(e);
                    }
                }
            }

            


            function connectButtons(buttonid) {
                const buttons = document.getElementById(buttonid);
                for (var b of buttons.getElementsByTagName('button')){
                    b.addEventListener("click", (event) => {

                        // extract and send the command
                        const re = /\.(.*)/;
                        cmd = event.target.id.match(re)[1];


                        if (cmd === 'RELOAD') {
                            location.reload();
                        } else {    
                            document.getElementById('command').value = `${cmd}`;
                            formSubmit(event);
                        }

                    });
                }
            }
            
          
        </script>




    </head>
    <body>

        <div id="row1" class="container">
            <h1>AVR-3808 DENON<i>strator...</i></h1>
            
        </div>

        <div class="container">

            <div class="column1">

                <div id="buttons1" class="buttons"> 
                    <button id=".RELOAD">Clear</button>
                    <button id=".PW?">PW?</button>
                    <button id=".PWSTANDBY">PWSTANDBY</button>
                </div>
                
                <div id="results">
                    <div>
                        <span>Time</span>
                        <span>Cmd</span>
                        <span>Result</span>
                    </div>
                </div>

                <form id="form" method="POST">
                    <input id="command" type="text" name="message" maxlength="15"/>
                    <input type="submit"/>
                </form>

            </div>
            
            <div class="column2">
                <div id="buttons2" class="buttons">  
                    <button id=".NSA">osd</button>
                </div>
                <div id="osd">
                    <span id="field0"></span>
                    <span id="field1"></span>
                    <span id="field2"></span>
                    <span id="field3"></span>
                    <span id="field4"></span>
                    <span id="field5"></span>
                    <span id="field6"></span>
                    <span id="field7"></span>
                    <span id="field8"></span>
                </div>
                

                

                <div id="buttons3" class="buttons">
                    <button id=".NS9H">rpt 1</button>
                    <button id=".NS9I">rpt all</button>
                    <button id=".NS9J">rpt off</button>
                    <button id=".NS9C">stop</button>

                    <div></div>
                    <button id=".NS9K">rnd all</button>
                    <button id=".NS9L">rnd off</button>
                    <div></div>

                    <div></div>
                    <button id=".NS90">up</button>
                    <div></div>
                    <button id=".NS9X">page up</button>

                    <button id=".NS92">left</button>
                    <button id=".NS94">ok</button>
                    <button id=".NS93">right</button>
                    <div></div>

                    <div></div>
                    <button id=".NS91">down</button>
                    <div></div>
                    <button id=".NS9Y">page dn</button>

                    <button id=".NS9E">skip -</button>
                    <button id=".NS9B">pause</button>
                    <button id=".NS9A">play</button>
                    <button id=".NS9D">skip +</button>
                </div>
            </div>

            
            



        </div>

        <div id="row3" class="container">
            <div id="online"></div>
        </div>

        
    </body>

    <script type="text/javascript">


        form.addEventListener( "submit", formSubmit );

        /*

        repeatone	repeatall	repeatoff   stop
		            randonall	randoff
			
	                up		                pageup

        left	    ok	        right	

	                down		            pagedown
			
        skipminus	pause	    play	    skipplus

        */


        clientConnect(aborter.signal);
        
        connectButtons('buttons1');
        connectButtons('buttons2');
        connectButtons('buttons3');

        

    </script>



</html>