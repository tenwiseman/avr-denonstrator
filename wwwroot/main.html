<!DOCTYPE html>
<html >
    <head>
        <title>Denonstrator</title>

        <style type="text/css">

            h1 {
                margin: 0;
            }

            .container {
                display: flex; 
                flex-wrap: wrap;
                width: 650px;
                padding:10px;
                border: 1px solid black;
                background-color: lightgray;
                font-family: Arial, Helvetica, sans-serif;
            }

            .column1, .column2 {
                flex: 1;
                width:50%;
            }

            .column2 {
                background-color: lightslategray;
            }



            #online {
                width:30px;
                height:20px;
                background-color: green;
            }

            /* BUTTONS */

            .buttons {
                display: flex; 
                flex-wrap: wrap;
                margin: 10px;
              
                height:160px;
            }

            .buttons button, .buttons div {
                flex: 1 0 21%;
                width:50px;
                height:20px;
                margin: 4px;
            }


            /* OSD */

            #osd {
               
                height: 220px;
                margin: 10px;
                border: 1px solid black;
                overflow: scroll;
                border-style: inset;
                background-color: black;
                color: cyan;
            }

            #osd span {
                margin: 0 10px;
                padding: 2px;
                display: block;
            }

            #osd span:first-child {
                margin: 10px;
                font-weight: bold;
                text-decoration: underline;
            }

            /* RESULTS */


            #results {
               
                height: 400px;
                border: 1px solid black;
                overflow: scroll;
                border-style: inset;
                background-color: linen;
            }

            


            #results span, #sosd span {
                padding: 2px;
                border: 1px solid lightgray;
                display: inline-block;
            }

            #results div:first-child {
                background-color: lightgray;
            }

            #results span:first-child {
                width: 80px;
            }

            #results span:nth-child(2) {
                width: 200px;
            }

        </style>

        <script type="text/javascript">

            const aborter = new AbortController();
            const decoder = new TextDecoder();

            /* connect streaming data input from server */

            async function clientConnect(signal) {
     
                // execute this function after window DOM loaded!

                const response = await fetch('http://localhost:8000/connect', { 
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: signal,
                    method: 'GET',
                });


                const online = document.getElementById('online');
                const results = document.getElementById('results');


                for await (const chunk of response.body) {
                    if (signal.aborted) throw signal.reason;
                    const whole = decoder.decode(chunk, { stream: true });

                    // CSV data is received in variable chunks of field pairs
                    // remove last comma, and split to fields 
                    const fields = whole.slice(0, -1).split(',');

                    for (let i = 0; i < fields.length; i += 2) {
                        switch (fields[i]) {
                            case 'error':
                                online.style.backgroundColor = 'red';
                                break;
                            case 'OK':
                                online.style.backgroundColor = 'green';
                                break;
                        }

                        if (fields[i] !== 'OK') { 
                            // first field - Command / Event   
                            const col1 = document.createElement('span');
                            const txt1 = document.createTextNode(fields[i]);
                            col1.appendChild(txt1);

                            // second field - Result
                            var result = fields[i+1];
                            const col2 = document.createElement('span');
                            
                            if (result.includes('NS')) {
                                osd = 'field' + result.substr(3, 1);
                                document.getElementById(osd).innerHTML = result.slice(4);
                            }
                            const txt2 = document.createTextNode(result);
                            col2.appendChild(txt2);

                            // create row, add field elements
                            const row = document.createElement('div');
                            row.appendChild(col1);
                            row.appendChild(col2);
                            results.appendChild(row);

                            row.scrollIntoView({block: "end", inline: "nearest"});
                        }
                    }
                }

            }

            // on form submit
            async function formSubmit(e) {
                e.preventDefault();
               
                const o = {};
                new FormData(form).forEach( ( value, key) => o[key] = value);

                const response = await fetch('http://localhost:8000/query', { 
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    method: 'POST',
                    body: JSON.stringify( o )
                });

                if(!response.ok) {
                    const msg = await response.text();
                    if (msg === 'Message is required') {
                        alert(msg);
                    } else if (msg === 'Reconnect Stream') {
                        clientConnect(aborter.signal);
                        formSubmit(e);
                    }
                }
            }

            // on button
            function buttonpress(e, cmd) {
                e.preventDefault();

                if (cmd === 'CLR') {
                    cmd = 'PW?'
                }

                document.getElementById('command').value = cmd;
                formSubmit(event);
            }


            function connectButtons() {
                const buttons = document.getElementById('buttons');
                for (var b of buttons.getElementsByTagName('button')){
                    b.addEventListener("click", (event) => {

                        // extract and send the command
                        cmd = event.target.id.slice(-2);
                        document.getElementById('command').value = `NS${cmd}`;
                        formSubmit(event);

                    });
                }
            }
            
          
        </script>




    </head>
    <body>

        <div class="container">
            <h1>DENONstrator</h1>
            
        </div>

        <div class="container">

            <div class="column1">

                <button id="clearevt">Clear</button>
                
                <div id="results">
                    <div><span>Event</span><span>Result</span></div>
                </div>

                <form id="form" method="POST">
                    <input id="command" type="text" name="message" maxlength="15"/>
                    <input type="submit"/>
                </form>

            </div>
            
            <div class="column2">  
                <button id="showosd">osd</button>
                <div id="osd">
                    <span id="field0"></span>
                    <span id="field1"></span>
                    <span id="field2"></span>
                    <span id="field3"></span>
                    <span id="field4"></span>
                    <span id="field5"></span>
                    <span id="field6"></span>
                    <span id="field7"></span>
                    <span id="field8"></span>
                </div>
                

                

                <div class="buttons">
                    <button id="repeatone9H">rpt 1</button>
                    <button id="repeatall9I">rpt all</button>
                    <button id="repeatoff9J">rpt off</button>
                    <button id="stop9C">stop</button>

                    <div></div>
                    <button id="randonall9K">rnd all</button>
                    <button id="randoff9L">rnd off</button>
                    <div></div>

                    <div></div>
                    <button id="up90">up</button>
                    <div></div>
                    <button id="pageup9X">page up</button>

                    <button id="left92">left</button>
                    <button id="ok94">ok</button>
                    <button id="right93">right</button>
                    <div></div>

                    <div></div>
                    <button id="down91">down</button>
                    <div></div>
                    <button id="pagedown9Y">page dn</button>

                    <button id="skipminus9E">skip -</button>
                    <button id="pause9B">pause</button>
                    <button id="play9A">play</button>
                    <button id="skipplus9D">skip +</button>
                </div>
            </div>

            
            



        </div>

        <div class="container">
            <div id="online"></div>
        </div>

        
    </body>

    <script type="text/javascript">


        form.addEventListener( "submit", formSubmit );

        /*

        repeatone	repeatall	repeatoff   stop
		            randonall	randoff
			
	                up		                pageup

        left	    ok	        right	

	                down		            pagedown
			
        skipminus	pause	    play	    skipplus

        */


        showosd.addEventListener( "click", (event) => buttonpress(event, 'NSA') );

        clearevt.addEventListener( "click", (event) => buttonpress(event, 'CLR') );

        clientConnect(aborter.signal);
        connectButtons();
        

    </script>



</html>